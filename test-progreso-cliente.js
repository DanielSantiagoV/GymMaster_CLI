/**
 * Pruebas B√°sicas para el M√≥dulo de Progreso de Clientes
 * 
 * Este archivo contiene pruebas manuales y automatizadas para verificar
 * el funcionamiento correcto del sistema de generaci√≥n de reportes de progreso.
 */

const { MongoClient } = require('mongodb');
const ClienteProgresoService = require('./services/ClienteProgresoService');
const fs = require('fs').promises;
const path = require('path');

/**
 * Configuraci√≥n de pruebas
 */
const TEST_CONFIG = {
    mongoUrl: process.env.MONGODB_URI || 'mongodb://localhost:27017/gymmaster',
    testClienteId: null,
    exportsDir: path.join(process.cwd(), 'exports')
};

/**
 * Clase para ejecutar pruebas del m√≥dulo de progreso
 */
class ProgresoClienteTester {
    constructor() {
        this.db = null;
        this.client = null;
        this.progresoService = null;
    }

    /**
     * Inicializa la conexi√≥n a la base de datos
     */
    async inicializar() {
        try {
            console.log('üîå Conectando a MongoDB para pruebas...');
            this.client = new MongoClient(TEST_CONFIG.mongoUrl);
            await this.client.connect();
            this.db = this.client.db('gymmaster');
            
            this.progresoService = new ClienteProgresoService(this.db);
            console.log('‚úÖ Conexi√≥n establecida correctamente\n');
        } catch (error) {
            console.error('‚ùå Error al conectar con MongoDB:', error.message);
            throw error;
        }
    }

    /**
     * Cierra la conexi√≥n a la base de datos
     */
    async cerrar() {
        if (this.client) {
            await this.client.close();
            console.log('üîå Conexi√≥n cerrada');
        }
    }

    /**
     * Ejecuta todas las pruebas
     */
    async ejecutarTodasLasPruebas() {
        console.log('üß™ INICIANDO PRUEBAS DEL M√ìDULO DE PROGRESO DE CLIENTES');
        console.log('=====================================================\n');

        try {
            await this.inicializar();

            // Ejecutar pruebas en orden
            await this.pruebaConexionBaseDatos();
            await this.pruebaBusquedaCliente();
            await this.pruebaGeneracionReporte();
            await this.pruebaEstructuraArchivo();
            await this.pruebaManejoErrores();
            await this.pruebaLimpiezaArchivos();

            console.log('\n‚úÖ TODAS LAS PRUEBAS COMPLETADAS EXITOSAMENTE');
            console.log('=============================================');

        } catch (error) {
            console.error('\n‚ùå ERROR EN LAS PRUEBAS:', error.message);
            console.error('=====================================');
        } finally {
            await this.cerrar();
        }
    }

    /**
     * Prueba 1: Conexi√≥n a base de datos
     */
    async pruebaConexionBaseDatos() {
        console.log('üìã PRUEBA 1: Conexi√≥n a Base de Datos');
        console.log('--------------------------------------');

        try {
            // Verificar que la conexi√≥n est√© activa
            await this.db.admin().ping();
            console.log('‚úÖ Conexi√≥n a MongoDB verificada');

            // Verificar colecciones existentes
            const colecciones = await this.db.listCollections().toArray();
            const nombresColecciones = colecciones.map(c => c.name);
            
            console.log(`‚úÖ Colecciones encontradas: ${nombresColecciones.join(', ')}`);
            
            // Verificar que existan las colecciones necesarias
            const coleccionesRequeridas = ['clientes', 'seguimientos', 'nutricion', 'planesentrenamiento', 'contratos'];
            const coleccionesFaltantes = coleccionesRequeridas.filter(c => !nombresColecciones.includes(c));
            
            if (coleccionesFaltantes.length > 0) {
                console.log(`‚ö†Ô∏è Colecciones faltantes: ${coleccionesFaltantes.join(', ')}`);
            } else {
                console.log('‚úÖ Todas las colecciones requeridas est√°n presentes');
            }

        } catch (error) {
            console.error('‚ùå Error en prueba de conexi√≥n:', error.message);
            throw error;
        }

        console.log('');
    }

    /**
     * Prueba 2: B√∫squeda de clientes
     */
    async pruebaBusquedaCliente() {
        console.log('üìã PRUEBA 2: B√∫squeda de Clientes');
        console.log('----------------------------------');

        try {
            // Buscar clientes existentes
            const clientes = await this.db.collection('clientes').find({}).limit(5).toArray();
            
            if (clientes.length === 0) {
                console.log('‚ö†Ô∏è No hay clientes en la base de datos');
                console.log('üí° Crear algunos clientes de prueba antes de continuar');
                return;
            }

            console.log(`‚úÖ Se encontraron ${clientes.length} clientes en la base de datos`);
            
            // Probar b√∫squeda por ID
            const primerCliente = clientes[0];
            const clientePorId = await this.progresoService.buscarCliente(primerCliente._id.toString());
            
            if (clientePorId) {
                console.log('‚úÖ B√∫squeda por ID funciona correctamente');
                TEST_CONFIG.testClienteId = primerCliente._id.toString();
            } else {
                console.log('‚ùå Error en b√∫squeda por ID');
            }

            // Probar b√∫squeda por nombre
            const clientePorNombre = await this.progresoService.buscarCliente(primerCliente.nombre);
            
            if (clientePorNombre) {
                console.log('‚úÖ B√∫squeda por nombre funciona correctamente');
            } else {
                console.log('‚ùå Error en b√∫squeda por nombre');
            }

            // Probar b√∫squeda por email
            const clientePorEmail = await this.progresoService.buscarCliente(primerCliente.email);
            
            if (clientePorEmail) {
                console.log('‚úÖ B√∫squeda por email funciona correctamente');
            } else {
                console.log('‚ùå Error en b√∫squeda por email');
            }

        } catch (error) {
            console.error('‚ùå Error en prueba de b√∫squeda:', error.message);
            throw error;
        }

        console.log('');
    }

    /**
     * Prueba 3: Generaci√≥n de reporte
     */
    async pruebaGeneracionReporte() {
        console.log('üìã PRUEBA 3: Generaci√≥n de Reporte');
        console.log('-----------------------------------');

        if (!TEST_CONFIG.testClienteId) {
            console.log('‚ö†Ô∏è No hay cliente de prueba disponible');
            return;
        }

        try {
            console.log(`üîç Generando reporte para cliente: ${TEST_CONFIG.testClienteId}`);
            
            const resultado = await this.progresoService.generarProgresoCliente(TEST_CONFIG.testClienteId);
            
            if (resultado.success) {
                console.log('‚úÖ Reporte generado exitosamente');
                console.log(`üìÑ Archivo: ${resultado.archivo.nombreArchivo}`);
                console.log(`üìÅ Ubicaci√≥n: ${resultado.archivo.rutaCompleta}`);
                console.log(`üìä Tama√±o: ${resultado.archivo.tama√±oBytes} bytes`);
                
                // Verificar que el archivo existe
                try {
                    await fs.access(resultado.archivo.rutaCompleta);
                    console.log('‚úÖ Archivo creado correctamente en el sistema de archivos');
                } catch (error) {
                    console.log('‚ùå Archivo no encontrado en el sistema de archivos');
                }

                // Mostrar estad√≠sticas
                console.log('üìä Estad√≠sticas del reporte:');
                console.log(`   - Seguimientos: ${resultado.estadisticas.seguimientos}`);
                console.log(`   - Planes nutricionales: ${resultado.estadisticas.planesNutricionales}`);
                console.log(`   - Planes de entrenamiento: ${resultado.estadisticas.planesEntrenamiento}`);
                console.log(`   - Contratos: ${resultado.estadisticas.contratos}`);

            } else {
                console.log('‚ùå Error al generar reporte:', resultado.mensaje);
            }

        } catch (error) {
            console.error('‚ùå Error en prueba de generaci√≥n:', error.message);
            throw error;
        }

        console.log('');
    }

    /**
     * Prueba 4: Estructura del archivo JSON
     */
    async pruebaEstructuraArchivo() {
        console.log('üìã PRUEBA 4: Estructura del Archivo JSON');
        console.log('----------------------------------------');

        try {
            // Buscar archivos de progreso generados
            const archivos = await fs.readdir(TEST_CONFIG.exportsDir);
            const archivosProgreso = archivos.filter(archivo => 
                archivo.endsWith('_progreso.json')
            );

            if (archivosProgreso.length === 0) {
                console.log('‚ö†Ô∏è No hay archivos de progreso para probar');
                return;
            }

            const archivoPrueba = path.join(TEST_CONFIG.exportsDir, archivosProgreso[0]);
            console.log(`üîç Analizando archivo: ${archivosProgreso[0]}`);

            // Leer y parsear el archivo JSON
            const contenido = await fs.readFile(archivoPrueba, 'utf8');
            const datos = JSON.parse(contenido);

            // Verificar estructura b√°sica
            const estructuraRequerida = [
                'metadatos',
                'cliente',
                'registrosAvance',
                'planesAlimentacion',
                'planesEntrenamiento',
                'contratos',
                'estadisticas'
            ];

            let estructuraValida = true;
            for (const seccion of estructuraRequerida) {
                if (datos[seccion]) {
                    console.log(`‚úÖ Secci√≥n '${seccion}' presente`);
                } else {
                    console.log(`‚ùå Secci√≥n '${seccion}' faltante`);
                    estructuraValida = false;
                }
            }

            if (estructuraValida) {
                console.log('‚úÖ Estructura JSON v√°lida');
            } else {
                console.log('‚ùå Estructura JSON inv√°lida');
            }

            // Verificar metadatos
            if (datos.metadatos) {
                console.log('üìã Metadatos del archivo:');
                console.log(`   - Fecha generaci√≥n: ${datos.metadatos.fechaGeneracion}`);
                console.log(`   - Versi√≥n: ${datos.metadatos.version}`);
                console.log(`   - Tipo: ${datos.metadatos.tipo}`);
            }

            // Verificar datos del cliente
            if (datos.cliente) {
                console.log('üë§ Datos del cliente:');
                console.log(`   - Nombre: ${datos.cliente.nombre}`);
                console.log(`   - Email: ${datos.cliente.email}`);
                console.log(`   - Activo: ${datos.cliente.activo}`);
            }

        } catch (error) {
            console.error('‚ùå Error en prueba de estructura:', error.message);
            throw error;
        }

        console.log('');
    }

    /**
     * Prueba 5: Manejo de errores
     */
    async pruebaManejoErrores() {
        console.log('üìã PRUEBA 5: Manejo de Errores');
        console.log('------------------------------');

        try {
            // Probar con cliente inexistente
            console.log('üîç Probando con cliente inexistente...');
            try {
                await this.progresoService.generarProgresoCliente('cliente_inexistente_123');
                console.log('‚ùå Deber√≠a haber fallado con cliente inexistente');
            } catch (error) {
                console.log('‚úÖ Error manejado correctamente:', error.message);
            }

            // Probar con ID inv√°lido
            console.log('üîç Probando con ID inv√°lido...');
            try {
                await this.progresoService.generarProgresoCliente('id_invalido');
                console.log('‚ùå Deber√≠a haber fallado con ID inv√°lido');
            } catch (error) {
                console.log('‚úÖ Error manejado correctamente:', error.message);
            }

            // Probar con entrada vac√≠a
            console.log('üîç Probando con entrada vac√≠a...');
            try {
                await this.progresoService.generarProgresoCliente('');
                console.log('‚ùå Deber√≠a haber fallado con entrada vac√≠a');
            } catch (error) {
                console.log('‚úÖ Error manejado correctamente:', error.message);
            }

            // Probar con entrada null
            console.log('üîç Probando con entrada null...');
            try {
                await this.progresoService.generarProgresoCliente(null);
                console.log('‚ùå Deber√≠a haber fallado con entrada null');
            } catch (error) {
                console.log('‚úÖ Error manejado correctamente:', error.message);
            }

        } catch (error) {
            console.error('‚ùå Error inesperado en prueba de manejo de errores:', error.message);
        }

        console.log('');
    }

    /**
     * Prueba 6: Limpieza de archivos
     */
    async pruebaLimpiezaArchivos() {
        console.log('üìã PRUEBA 6: Limpieza de Archivos');
        console.log('---------------------------------');

        try {
            // Contar archivos antes de limpiar
            const archivosAntes = await fs.readdir(TEST_CONFIG.exportsDir);
            const archivosProgresoAntes = archivosAntes.filter(archivo => 
                archivo.endsWith('_progreso.json')
            );

            console.log(`üìä Archivos de progreso antes de limpiar: ${archivosProgresoAntes.length}`);

            if (archivosProgresoAntes.length > 0) {
                // Limpiar archivos de progreso
                for (const archivo of archivosProgresoAntes) {
                    try {
                        await fs.unlink(path.join(TEST_CONFIG.exportsDir, archivo));
                        console.log(`üóëÔ∏è Archivo eliminado: ${archivo}`);
                    } catch (error) {
                        console.log(`‚ùå Error al eliminar ${archivo}: ${error.message}`);
                    }
                }

                // Verificar limpieza
                const archivosDespues = await fs.readdir(TEST_CONFIG.exportsDir);
                const archivosProgresoDespues = archivosDespues.filter(archivo => 
                    archivo.endsWith('_progreso.json')
                );

                console.log(`üìä Archivos de progreso despu√©s de limpiar: ${archivosProgresoDespues.length}`);

                if (archivosProgresoDespues.length === 0) {
                    console.log('‚úÖ Limpieza completada exitosamente');
                } else {
                    console.log('‚ö†Ô∏è Algunos archivos no se pudieron eliminar');
                }
            } else {
                console.log('‚ÑπÔ∏è No hay archivos de progreso para limpiar');
            }

        } catch (error) {
            console.error('‚ùå Error en prueba de limpieza:', error.message);
        }

        console.log('');
    }
}

/**
 * Funci√≥n principal para ejecutar las pruebas
 */
async function ejecutarPruebas() {
    const tester = new ProgresoClienteTester();
    await tester.ejecutarTodasLasPruebas();
}

/**
 * Ejecutar pruebas si el archivo se ejecuta directamente
 */
if (require.main === module) {
    ejecutarPruebas().catch(error => {
        console.error('üí• Error fatal en las pruebas:', error);
        process.exit(1);
    });
}

module.exports = ProgresoClienteTester;